<!doctype html><html lang=en-us dir=ltr><head><meta charset=utf-8><meta name=viewport content='width=device-width,initial-scale=1'><meta name=description content="Suppose there are 100 requests to be sent, design an algorithm to control concurrent requests (with a maximum concurrency of 10) using Promise, to complete all 100 requests."><title>How to control multiple concurrent requests?</title>
<link rel=canonical href=https://www.skstory.online/p/how-to-control-multiple-concurrent-requests/><link rel=stylesheet href=/scss/style.min.663803bebe609202d5b39d848f2d7c2dc8b598a2d879efa079fa88893d29c49c.css><meta property='og:title' content="How to control multiple concurrent requests?"><meta property='og:description' content="Suppose there are 100 requests to be sent, design an algorithm to control concurrent requests (with a maximum concurrency of 10) using Promise, to complete all 100 requests."><meta property='og:url' content='https://www.skstory.online/p/how-to-control-multiple-concurrent-requests/'><meta property='og:site_name' content='SK Story'><meta property='og:type' content='article'><meta property='article:section' content='Post'><meta property='article:tag' content='Code'><meta property='article:tag' content='Javascript'><meta property='article:published_time' content='2024-06-06T16:22:38+08:00'><meta property='article:modified_time' content='2024-06-06T16:22:38+08:00'><meta property='og:image' content='https://miro.medium.com/v2/resize:fit:1400/format:webp/1*C7wa55tbYeJsoU9Ay8BbRg.jpeg'><meta name=twitter:site content="@https://twitter.com/ShawnKxming"><meta name=twitter:creator content="@https://twitter.com/ShawnKxming"><meta name=twitter:title content="How to control multiple concurrent requests?"><meta name=twitter:description content="Suppose there are 100 requests to be sent, design an algorithm to control concurrent requests (with a maximum concurrency of 10) using Promise, to complete all 100 requests."><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content='https://miro.medium.com/v2/resize:fit:1400/format:webp/1*C7wa55tbYeJsoU9Ay8BbRg.jpeg'><link rel="shortcut icon" href=/favicon.ico></head><body class=article-page><script>(function(){const e="StackColorScheme";localStorage.getItem(e)||localStorage.setItem(e,"auto")})()</script><script>(function(){const t="StackColorScheme",e=localStorage.getItem(t),n=window.matchMedia("(prefers-color-scheme: dark)").matches===!0;e=="dark"||e==="auto"&&n?document.documentElement.dataset.scheme="dark":document.documentElement.dataset.scheme="light"})()</script><div class="container main-container flex on-phone--column extended"><aside class="sidebar left-sidebar sticky"><button class="hamburger hamburger--spin" type=button id=toggle-menu aria-label="Toggle Menu">
<span class=hamburger-box><span class=hamburger-inner></span></span></button><header><figure class=site-avatar><a href=/><img src=/img/avatar_hu1157332405703967761.jpeg width=300 height=300 class=site-logo loading=lazy alt=Avatar>
</a><span class=emoji>üç•</span></figure><div class=site-meta><h1 class=site-name><a href=/>SK Story</a></h1><h2 class=site-description>Shawn King's Stories Website</h2></div></header><ol class=menu-social><li><a href=mailto:kxming0229@gmail.com target=_blank title=Email rel=me><svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-tabler icons-tabler-outline icon-tabler-mail"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M3 7a2 2 0 012-2h14a2 2 0 012 2v10a2 2 0 01-2 2H5a2 2 0 01-2-2V7z"/><path d="M3 7l9 6 9-6"/></svg></a></li><li><a href=https://www.facebook.com/p/King-Shawn-100092679065959/ target=_blank title=Facebook rel=me><svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-tabler icons-tabler-outline icon-tabler-brand-facebook"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M7 10v4h3v7h4v-7h3l1-4h-4V8a1 1 0 011-1h3V3h-3a5 5 0 00-5 5v2H7"/></svg></a></li><li><a href=https://twitter.com/ShawnKxming target=_blank title=Twitter rel=me><svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-tabler icons-tabler-outline icon-tabler-brand-x"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M4 4l11.733 16H20L8.267 4z"/><path d="M4 20l6.768-6.768m2.46-2.46L20 4"/></svg></a></li><li><a href=https://t.me/shawnkxming target=_blank title=Telegram rel=me><svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-tabler icons-tabler-outline icon-tabler-brand-telegram"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M15 10l-4 4 6 6 4-16-18 7 4 2 2 6 3-4"/></svg></a></li><li><a href=https://medium.com/@kxming target=_blank title=Medium rel=me><svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-tabler icons-tabler-outline icon-tabler-brand-medium"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M4 4m0 2a2 2 0 012-2h12a2 2 0 012 2v12a2 2 0 01-2 2H6a2 2 0 01-2-2z"/><path d="M8 9h1l3 3 3-3h1"/><path d="M8 15h2"/><path d="M14 15h2"/><path d="M9 9v6"/><path d="M15 9v6"/></svg></a></li></ol><ol class=menu id=main-menu><li><a href=/><svg class="icon icon-tabler icon-tabler-home" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><polyline points="5 12 3 12 12 3 21 12 19 12"/><path d="M5 12v7a2 2 0 002 2h10a2 2 0 002-2v-7"/><path d="M9 21v-6a2 2 0 012-2h2a2 2 0 012 2v6"/></svg>
<span>Home</span></a></li><li><a href=/archives/><svg class="icon icon-tabler icon-tabler-archive" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><rect x="3" y="4" width="18" height="4" rx="2"/><path d="M5 8v10a2 2 0 002 2h10a2 2 0 002-2V8"/><line x1="10" y1="12" x2="14" y2="12"/></svg>
<span>Archives</span></a></li><li><a href=/search/><svg class="icon icon-tabler icon-tabler-search" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="10" cy="10" r="7"/><line x1="21" y1="21" x2="15" y2="15"/></svg>
<span>Search</span></a></li><li><a href=/links/><svg class="icon icon-tabler icon-tabler-link" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><path d="M10 14a3.5 3.5.0 005 0l4-4a3.5 3.5.0 00-5-5l-.5.5"/><path d="M14 10a3.5 3.5.0 00-5 0l-4 4a3.5 3.5.0 005 5l.5-.5"/></svg>
<span>Links</span></a></li><li><a href=/about/><svg class="icon icon-tabler icon-tabler-user" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="7" r="4"/><path d="M6 21v-2a4 4 0 014-4h4a4 4 0 014 4v2"/></svg>
<span>About</span></a></li><li class=menu-bottom-section><ol class=menu><li id=dark-mode-toggle><svg class="icon icon-tabler icon-tabler-toggle-left" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="8" cy="12" r="2"/><rect x="2" y="6" width="20" height="12" rx="6"/></svg>
<svg class="icon icon-tabler icon-tabler-toggle-right" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="16" cy="12" r="2"/><rect x="2" y="6" width="20" height="12" rx="6"/></svg>
<span>Dark Mode</span></li></ol></li></ol></aside><aside class="sidebar right-sidebar sticky"><section class="widget archives"><div class=widget-icon><svg class="icon icon-tabler icon-tabler-hash" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><line x1="5" y1="9" x2="19" y2="9"/><line x1="5" y1="15" x2="19" y2="15"/><line x1="11" y1="4" x2="7" y2="20"/><line x1="17" y1="4" x2="13" y2="20"/></svg></div><h2 class="widget-title section-title">Table of contents</h2><div class=widget--toc><nav id=TableOfContents><ol><li><a href=#promiseall>Promise.all()</a></li><li><a href=#promiseallsettled>Promise.allSettled()</a></li><li><a href=#summary>Summary</a></li></ol></nav></div></section></aside><main class="main full-width"><article class="has-image main-article"><header class=article-header><div class=article-image><a href=/p/how-to-control-multiple-concurrent-requests/><img src=https://miro.medium.com/v2/resize:fit:1400/format:webp/1*C7wa55tbYeJsoU9Ay8BbRg.jpeg loading=lazy alt="Featured image of post How to control multiple concurrent requests?"></a></div><div class=article-details><header class=article-category><a href=/categories/code/>Code
</a><a href=/categories/javascript/ style=background-color:#d1d419;color:#fff>Javascript</a></header><div class=article-title-wrapper><h2 class=article-title><a href=/p/how-to-control-multiple-concurrent-requests/>How to control multiple concurrent requests?</a></h2><h3 class=article-subtitle>Suppose there are 100 requests to be sent, design an algorithm to control concurrent requests (with a maximum concurrency of 10) using Promise, to complete all 100 requests.</h3></div><footer class=article-time><div><svg class="icon icon-tabler icon-tabler-calendar-time" width="56" height="56" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><path d="M11.795 21H5a2 2 0 01-2-2V7a2 2 0 012-2h12a2 2 0 012 2v4"/><circle cx="18" cy="18" r="4"/><path d="M15 3v4"/><path d="M7 3v4"/><path d="M3 11h16"/><path d="M18 16.496V18l1 1"/></svg>
<time class=article-time--published>Jun 06, 2024</time></div><div><svg class="icon icon-tabler icon-tabler-clock" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="12" r="9"/><polyline points="12 7 12 12 15 15"/></svg>
<time class=article-time--reading>5 minute read</time></div></footer></div></header><section class=article-content><p>First, let‚Äôs simulate the 100 requests:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-gdscript3 data-lang=gdscript3><span class=line><span class=cl><span class=o>//</span> <span class=n>Request</span> <span class=n>List</span>
</span></span><span class=line><span class=cl><span class=k>const</span> <span class=n>requestList</span> <span class=o>=</span> <span class=p>[];</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>for</span> <span class=p>(</span><span class=n>let</span> <span class=n>i</span> <span class=o>=</span> <span class=mi>1</span><span class=p>;</span> <span class=n>i</span> <span class=o>&lt;=</span> <span class=mi>100</span><span class=p>;</span> <span class=n>i</span><span class=o>++</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=n>requestList</span><span class=o>.</span><span class=n>push</span><span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=p>()</span> <span class=o>=&gt;</span>
</span></span><span class=line><span class=cl>      <span class=n>new</span> <span class=n>Promise</span><span class=p>(</span><span class=n>resolve</span> <span class=o>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=n>setTimeout</span><span class=p>(()</span> <span class=o>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>          <span class=n>console</span><span class=o>.</span><span class=n>log</span><span class=p>(</span><span class=s1>&#39;done&#39;</span><span class=p>,</span> <span class=n>i</span><span class=p>);</span>
</span></span><span class=line><span class=cl>          <span class=n>resolve</span><span class=p>(</span><span class=n>i</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=p>},</span> <span class=n>Math</span><span class=o>.</span><span class=n>random</span><span class=p>()</span> <span class=o>*</span> <span class=mi>1000</span><span class=p>);</span>
</span></span><span class=line><span class=cl>      <span class=p>}),</span>
</span></span><span class=line><span class=cl>  <span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><h2 id=promiseall>Promise.all()</h2><p>Upon first encountering this problem, most people would likely think of <code>Promise.all</code>, as it is the most common way to handle concurrent requests. Let‚Äôs implement it:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-gdscript3 data-lang=gdscript3><span class=line><span class=cl><span class=k>const</span> <span class=n>parallelRun</span> <span class=o>=</span> <span class=n>async</span> <span class=nb>max</span> <span class=o>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=k>const</span> <span class=n>requestSliceList</span> <span class=o>=</span> <span class=p>[];</span>
</span></span><span class=line><span class=cl>  <span class=k>for</span> <span class=p>(</span><span class=n>let</span> <span class=n>i</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span> <span class=n>i</span> <span class=o>&lt;</span> <span class=n>requestList</span><span class=o>.</span><span class=n>length</span><span class=p>;</span> <span class=n>i</span> <span class=o>+=</span> <span class=nb>max</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=n>requestSliceList</span><span class=o>.</span><span class=n>push</span><span class=p>(</span><span class=n>requestList</span><span class=o>.</span><span class=n>slice</span><span class=p>(</span><span class=n>i</span><span class=p>,</span> <span class=n>i</span> <span class=o>+</span> <span class=nb>max</span><span class=p>));</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=k>for</span> <span class=p>(</span><span class=n>let</span> <span class=n>i</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span> <span class=n>i</span> <span class=o>&lt;</span> <span class=n>requestSliceList</span><span class=o>.</span><span class=n>length</span><span class=p>;</span> <span class=n>i</span><span class=o>++</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>const</span> <span class=n>group</span> <span class=o>=</span> <span class=n>requestSliceList</span><span class=p>[</span><span class=n>i</span><span class=p>];</span>
</span></span><span class=line><span class=cl>    <span class=n>try</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=k>const</span> <span class=n>res</span> <span class=o>=</span> <span class=n>await</span> <span class=n>Promise</span><span class=o>.</span><span class=n>all</span><span class=p>(</span><span class=n>group</span><span class=o>.</span><span class=n>map</span><span class=p>(</span><span class=n>fn</span> <span class=o>=&gt;</span> <span class=n>fn</span><span class=p>()));</span>
</span></span><span class=line><span class=cl>      <span class=n>console</span><span class=o>.</span><span class=n>log</span><span class=p>(</span><span class=s1>&#39;Response:&#39;</span><span class=p>,</span> <span class=n>res</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span> <span class=n>catch</span> <span class=p>(</span><span class=n>error</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=n>console</span><span class=o>.</span><span class=n>error</span><span class=p>(</span><span class=n>error</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>};</span>
</span></span></code></pre></td></tr></table></div></div><p>The result:</p><p><img src=https://miro.medium.com/v2/resize:fit:1400/format:webp/1*LCXXm4fQqiX41fnDuOl1jQ.gif loading=lazy></p><p>Each time, 10 requests are sent concurrently. Once these 10 requests are completed, the next 10 requests are sent, perfectly fulfilling the requirement.</p><p>However, a new question arises: what happens if one of these requests fails?</p><p><img src=https://miro.medium.com/v2/resize:fit:1400/format:webp/1*v1Mywb8-45hHXLw2rX2z2g.gif loading=lazy></p><p>If there‚Äôs a failure in one request, the entire <code>Promise.all</code> fails without returning any value. If one request in a group fails, it becomes impossible to retrieve the return values of the other members in that group. While this may be acceptable in scenarios where return values aren‚Äôt necessary, in actual business practices, return values are crucial data.</p><p>We can tolerate the lack of a return value from a failed interface, but it‚Äôs unacceptable for a failure in one request to result in no return values for the other 9 requests in the same group.</p><p>Given that a failed request interrupts <code>Promise.all</code>, is there a method to avoid being disrupted by failures?</p><p>Indeed, there is ‚Äî it‚Äôs called <code>Promise.allSettled</code>!</p><h2 id=promiseallsettled>Promise.allSettled()</h2><p>Let‚Äôs take a look at the introduction from MDN.</p><blockquote><p>The <code>Promise.allSettled()</code> method is one of the promise concurrency methods. <code>Promise.allSettled()</code> is typically used when you have multiple asynchronous tasks that are not dependent on one another to complete successfully, or you&rsquo;d always like to know the result of each promise.</p></blockquote><p>Replace <code>Promise.all()</code> with <code>Promise.allSettled()</code>:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-gdscript3 data-lang=gdscript3><span class=line><span class=cl><span class=k>const</span> <span class=n>parallelRun</span> <span class=o>=</span> <span class=n>async</span> <span class=nb>max</span> <span class=o>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=k>const</span> <span class=n>requestSliceList</span> <span class=o>=</span> <span class=p>[];</span>
</span></span><span class=line><span class=cl>  <span class=k>for</span> <span class=p>(</span><span class=n>let</span> <span class=n>i</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span> <span class=n>i</span> <span class=o>&lt;</span> <span class=n>requestList</span><span class=o>.</span><span class=n>length</span><span class=p>;</span> <span class=n>i</span> <span class=o>+=</span> <span class=nb>max</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=n>requestSliceList</span><span class=o>.</span><span class=n>push</span><span class=p>(</span><span class=n>requestList</span><span class=o>.</span><span class=n>slice</span><span class=p>(</span><span class=n>i</span><span class=p>,</span> <span class=n>i</span> <span class=o>+</span> <span class=nb>max</span><span class=p>));</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=k>for</span> <span class=p>(</span><span class=n>let</span> <span class=n>i</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span> <span class=n>i</span> <span class=o>&lt;</span> <span class=n>requestSliceList</span><span class=o>.</span><span class=n>length</span><span class=p>;</span> <span class=n>i</span><span class=o>++</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>const</span> <span class=n>group</span> <span class=o>=</span> <span class=n>requestSliceList</span><span class=p>[</span><span class=n>i</span><span class=p>];</span>
</span></span><span class=line><span class=cl>    <span class=n>try</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=o>//</span> <span class=n>Replace</span>
</span></span><span class=line><span class=cl>      <span class=k>const</span> <span class=n>res</span> <span class=o>=</span> <span class=n>await</span> <span class=n>Promise</span><span class=o>.</span><span class=n>allSettled</span><span class=p>(</span><span class=n>group</span><span class=o>.</span><span class=n>map</span><span class=p>(</span><span class=n>fn</span> <span class=o>=&gt;</span> <span class=n>fn</span><span class=p>()));</span>
</span></span><span class=line><span class=cl>      <span class=n>console</span><span class=o>.</span><span class=n>log</span><span class=p>(</span><span class=s1>&#39;Response: &#39;</span><span class=p>,</span> <span class=n>res</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span> <span class=n>catch</span> <span class=p>(</span><span class=n>error</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=n>console</span><span class=o>.</span><span class=n>error</span><span class=p>(</span><span class=n>error</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>};</span>
</span></span></code></pre></td></tr></table></div></div><p>The result:</p><p><img src=https://miro.medium.com/v2/resize:fit:1400/format:webp/1*BBTMDkKPMIoetXqB4_4NSg.png loading=lazy></p><p>As can be seen, when all interfaces return values normally, the return values will accurately record whether the current request succeeded or failed.</p><p>New question: If one request is very time-consuming, the response of that group of requests will be slow, blocking subsequent concurrent interface calls.</p><p><strong>Analyse</strong>:</p><p>Using <code>Promise.all()</code> or <code>Promise.allSettled()</code> to concurrently handle 10 requests at a time can indeed meet concurrency requirements, but the efficiency is low. If there is one or more slow interfaces, two problems will occur:</p><ol><li><p>The return of the concurrent group with the slow interface will be very slow; one slow interface delays the other nine, which is counterproductive.</p></li><li><p>Although we are capable of handling 10 concurrent requests, a slow interface causes the other nine concurrent slots in that group to be wasted, which cruelly extends the concurrency time for these 100 interfaces.</p></li><li><p>The subsequent concurrent groups behind the slow interface group are all blocked, making it even slower.</p></li></ol><p><strong>Solution</strong>:</p><p>A running pool and a waiting queue can be maintained, always keeping 10 requests concurrently in the running pool.</p><p>When one request in the running pool is completed, a new request is taken from the waiting queue and placed into the running pool to run, thus ensuring the running pool is always operating at full capacity.</p><p>Even if there is a slow interface, it will not block subsequent interfaces from entering the pool.</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span><span class=lnt>51
</span><span class=lnt>52
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-gdscript3 data-lang=gdscript3><span class=line><span class=cl><span class=o>//</span> <span class=n>Running</span> <span class=n>pool</span>
</span></span><span class=line><span class=cl><span class=k>const</span> <span class=n>pool</span> <span class=o>=</span> <span class=n>new</span> <span class=n>Set</span><span class=p>();</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=o>//</span> <span class=n>Waiting</span> <span class=n>queue</span>
</span></span><span class=line><span class=cl><span class=k>const</span> <span class=n>waitQueue</span> <span class=o>=</span> <span class=p>[];</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=o>/**</span>
</span></span><span class=line><span class=cl> <span class=o>*</span> <span class=err>@</span><span class=n>description</span><span class=p>:</span> <span class=n>Limit</span> <span class=n>the</span> <span class=n>number</span> <span class=n>of</span> <span class=n>concurrent</span> <span class=n>requests</span>
</span></span><span class=line><span class=cl> <span class=o>*</span> <span class=err>@</span><span class=n>param</span> <span class=p>{</span><span class=o>*</span><span class=p>}</span> <span class=n>reqFn</span><span class=p>:</span> <span class=n>Request</span> <span class=n>method</span>
</span></span><span class=line><span class=cl> <span class=o>*</span> <span class=err>@</span><span class=n>param</span> <span class=p>{</span><span class=o>*</span><span class=p>}</span> <span class=nb>max</span><span class=p>:</span> <span class=n>Maximum</span> <span class=n>concurrency</span>
</span></span><span class=line><span class=cl> <span class=o>*/</span>
</span></span><span class=line><span class=cl><span class=k>const</span> <span class=n>request</span> <span class=o>=</span> <span class=p>(</span><span class=n>reqFn</span><span class=p>,</span> <span class=nb>max</span><span class=p>)</span> <span class=o>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=k>return</span> <span class=n>new</span> <span class=n>Promise</span><span class=p>((</span><span class=n>resolve</span><span class=p>,</span> <span class=n>reject</span><span class=p>)</span> <span class=o>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=o>//</span> <span class=n>Check</span> <span class=k>if</span> <span class=n>the</span> <span class=n>running</span> <span class=n>pool</span> <span class=n>is</span> <span class=n>full</span>
</span></span><span class=line><span class=cl>    <span class=k>const</span> <span class=n>isFull</span> <span class=o>=</span> <span class=n>pool</span><span class=o>.</span><span class=n>size</span> <span class=o>&gt;=</span> <span class=nb>max</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=o>//</span> <span class=n>Wrapped</span> <span class=n>new</span> <span class=n>request</span>
</span></span><span class=line><span class=cl>    <span class=k>const</span> <span class=n>newReqFn</span> <span class=o>=</span> <span class=p>()</span> <span class=o>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=n>reqFn</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=o>.</span><span class=n>then</span><span class=p>(</span><span class=n>res</span> <span class=o>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>          <span class=n>resolve</span><span class=p>(</span><span class=n>res</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=p>})</span>
</span></span><span class=line><span class=cl>        <span class=o>.</span><span class=n>catch</span><span class=p>(</span><span class=n>err</span> <span class=o>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>          <span class=n>reject</span><span class=p>(</span><span class=n>err</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=p>})</span>
</span></span><span class=line><span class=cl>        <span class=o>.</span><span class=n>finally</span><span class=p>(()</span> <span class=o>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>          <span class=o>//</span> <span class=n>After</span> <span class=n>the</span> <span class=n>request</span> <span class=n>is</span> <span class=n>completed</span><span class=p>,</span> <span class=n>remove</span> <span class=n>it</span> <span class=n>from</span> <span class=n>the</span> <span class=n>running</span> <span class=n>pool</span>
</span></span><span class=line><span class=cl>          <span class=n>pool</span><span class=o>.</span><span class=n>delete</span><span class=p>(</span><span class=n>newReqFn</span><span class=p>);</span>
</span></span><span class=line><span class=cl>          <span class=o>//</span> <span class=n>Take</span> <span class=n>out</span> <span class=n>a</span> <span class=n>new</span> <span class=n>request</span> <span class=n>from</span> <span class=n>the</span> <span class=n>waiting</span> <span class=n>queue</span> <span class=ow>and</span> <span class=n>put</span> <span class=n>it</span> <span class=n>into</span> <span class=n>the</span> <span class=n>running</span> <span class=n>pool</span> <span class=k>for</span> <span class=n>execution</span>
</span></span><span class=line><span class=cl>          <span class=k>const</span> <span class=n>next</span> <span class=o>=</span> <span class=n>waitQueue</span><span class=o>.</span><span class=n>shift</span><span class=p>();</span>
</span></span><span class=line><span class=cl>          <span class=k>if</span> <span class=p>(</span><span class=n>next</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=n>pool</span><span class=o>.</span><span class=n>add</span><span class=p>(</span><span class=n>next</span><span class=p>);</span>
</span></span><span class=line><span class=cl>            <span class=n>next</span><span class=p>();</span>
</span></span><span class=line><span class=cl>          <span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=p>});</span>
</span></span><span class=line><span class=cl>    <span class=p>};</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=n>isFull</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=o>//</span> <span class=n>If</span> <span class=n>the</span> <span class=n>running</span> <span class=n>pool</span> <span class=n>is</span> <span class=n>full</span><span class=p>,</span> <span class=n>put</span> <span class=n>the</span> <span class=n>new</span> <span class=n>request</span> <span class=n>into</span> <span class=n>the</span> <span class=n>waiting</span> <span class=n>queue</span>
</span></span><span class=line><span class=cl>      <span class=n>waitQueue</span><span class=o>.</span><span class=n>push</span><span class=p>(</span><span class=n>newReqFn</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=o>//</span> <span class=n>If</span> <span class=n>the</span> <span class=n>running</span> <span class=n>pool</span> <span class=n>is</span> <span class=ow>not</span> <span class=n>full</span><span class=p>,</span> <span class=n>add</span> <span class=n>a</span> <span class=n>new</span> <span class=n>request</span> <span class=n>to</span> <span class=n>the</span> <span class=n>pool</span> <span class=ow>and</span> <span class=n>execute</span> <span class=n>it</span>
</span></span><span class=line><span class=cl>      <span class=n>pool</span><span class=o>.</span><span class=n>add</span><span class=p>(</span><span class=n>newReqFn</span><span class=p>);</span>
</span></span><span class=line><span class=cl>      <span class=n>newReqFn</span><span class=p>();</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=p>});</span>
</span></span><span class=line><span class=cl><span class=p>};</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>requestList</span><span class=o>.</span><span class=n>forEach</span><span class=p>(</span><span class=n>async</span> <span class=n>item</span> <span class=o>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=k>const</span> <span class=n>res</span> <span class=o>=</span> <span class=n>await</span> <span class=n>request</span><span class=p>(</span><span class=n>item</span><span class=p>,</span> <span class=mi>10</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=n>console</span><span class=o>.</span><span class=n>log</span><span class=p>(</span><span class=n>res</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>});</span>
</span></span></code></pre></td></tr></table></div></div><p>The result:</p><p><img src=https://miro.medium.com/v2/resize:fit:1400/format:webp/1*1vE8yqXy4Zksy1rXN9R9xw.gif loading=lazy></p><p>As can be seen, the 100 interfaces are executed continuously without any waiting or blocking.</p><h2 id=summary>Summary</h2><p>This article mainly summarizes methods to limit concurrency for 100 requests:</p><ul><li><p><code>Promise.all()</code> is the simplest way to control concurrency, but if a request fails, that group will not return a value.</p></li><li><p><code>Promise.allSettled()</code> solves the issue of <code>Promise.all()</code>, but it suffers from slow interfaces blocking subsequent requests and wasting other concurrent slots.</p></li><li><p>By maintaining a running pool, when a request in the pool completes, a new request is taken from the waiting queue and added to the pool for execution until all requests have entered the pool.</p></li></ul></section><footer class=article-footer><section class=article-tags><a href=/tags/code/>Code</a>
<a href=/tags/javascript/>Javascript</a></section><section class=article-copyright><svg class="icon icon-tabler icon-tabler-copyright" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="12" r="9"/><path d="M14.5 9a3.5 4 0 100 6"/></svg>
<span>Licensed under CC BY-NC-SA 4.0</span></section></footer></article><aside class=related-content--wrapper><h2 class=section-title>Related content</h2><div class=related-content><div class="flex article-list--tile"><article class=has-image><a href=/p/advanced-usage-of-reduce-you-might-not-know/><div class=article-image><img src=https://miro.medium.com/v2/resize:fit:1400/format:webp/1*h7QTz6KqyeYG_ausGQjj5g.jpeg loading=lazy data-key data-hash=https://miro.medium.com/v2/resize:fit:1400/format:webp/1*h7QTz6KqyeYG_ausGQjj5g.jpeg></div><div class=article-details><h2 class=article-title>Advanced Usage of Reduce You Might Not Know</h2></div></a></article><article class=has-image><a href=/p/vue3-performance-optimization-code-level-optimization/><div class=article-image><img src=https://miro.medium.com/v2/resize:fit:1400/format:webp/1*KZsES-HkGUvu6TkmfmNMBA.png loading=lazy data-key data-hash=https://miro.medium.com/v2/resize:fit:1400/format:webp/1*KZsES-HkGUvu6TkmfmNMBA.png></div><div class=article-details><h2 class=article-title>Vue3 Performance Optimization ‚Äî Code-Level Optimization</h2></div></a></article><article class=has-image><a href=/p/vue3-performance-optimization-bundle-optimization/><div class=article-image><img src=https://miro.medium.com/v2/resize:fit:1400/format:webp/1*KZsES-HkGUvu6TkmfmNMBA.png loading=lazy data-key data-hash=https://miro.medium.com/v2/resize:fit:1400/format:webp/1*KZsES-HkGUvu6TkmfmNMBA.png></div><div class=article-details><h2 class=article-title>Vue3 Performance Optimization ‚Äî Bundle Optimization</h2></div></a></article><article class=has-image><a href=/p/how-much-do-you-know-about-29-javascript-object-methods/><div class=article-image><img src=https://miro.medium.com/v2/resize:fit:1400/format:webp/1*l_w8hkehf25Nx3H_AzEVbQ.jpeg loading=lazy data-key data-hash=https://miro.medium.com/v2/resize:fit:1400/format:webp/1*l_w8hkehf25Nx3H_AzEVbQ.jpeg></div><div class=article-details><h2 class=article-title>How Much Do You Know About 29 JavaScript Object Methods?</h2></div></a></article><article class=has-image><a href=/p/most-of-the-books-youve-read-are-mostly-forgotten-so-why-keep-reading/><div class=article-image><img src=https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Zm-09l_F3UwVf2IneHGHew.jpeg loading=lazy data-key data-hash=https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Zm-09l_F3UwVf2IneHGHew.jpeg></div><div class=article-details><h2 class=article-title>Most of the books you‚Äôve read are mostly forgotten, so why keep reading?</h2></div></a></article></div></div></aside><script src=https://giscus.app/client.js data-repo=kxming/skstory data-repo-id=R_kgDOLehX4A data-category=Announcements data-category-id=DIC_kwDOLehX4M4Cd4Vx data-mapping=pathname data-strict=0 data-reactions-enabled=1 data-emit-metadata=0 data-input-position=top data-theme=light data-lang=en-us data-loading crossorigin=anonymous async></script><script>function setGiscusTheme(e){let t=document.querySelector("iframe.giscus-frame");t&&t.contentWindow.postMessage({giscus:{setConfig:{theme:e}}},"https://giscus.app")}(function(){addEventListener("message",t=>{if(event.origin!=="https://giscus.app")return;e()}),window.addEventListener("onColorSchemeChange",e);function e(){setGiscusTheme(document.documentElement.dataset.scheme==="light"?"light":"dark_dimmed")}})()</script><footer class=site-footer><section class=copyright>&copy;
2024 SK Story</section><section class=powerby>Built with <a href=https://gohugo.io/ target=_blank rel=noopener>Hugo</a><br>Theme <b><a href=https://github.com/CaiJimmy/hugo-theme-stack target=_blank rel=noopener data-version=3.29.0>Stack</a></b> designed by <a href=https://jimmycai.com target=_blank rel=noopener>Jimmy</a></section></footer><div class=pswp tabindex=-1 role=dialog aria-hidden=true><div class=pswp__bg></div><div class=pswp__scroll-wrap><div class=pswp__container><div class=pswp__item></div><div class=pswp__item></div><div class=pswp__item></div></div><div class="pswp__ui pswp__ui--hidden"><div class=pswp__top-bar><div class=pswp__counter></div><button class="pswp__button pswp__button--close" title="Close (Esc)"></button>
<button class="pswp__button pswp__button--share" title=Share></button>
<button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>
<button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button><div class=pswp__preloader><div class=pswp__preloader__icn><div class=pswp__preloader__cut><div class=pswp__preloader__donut></div></div></div></div></div><div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap"><div class=pswp__share-tooltip></div></div><button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
</button>
<button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)"></button><div class=pswp__caption><div class=pswp__caption__center></div></div></div></div></div><script src=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.js integrity="sha256-ePwmChbbvXbsO02lbM3HoHbSHTHFAeChekF1xKJdleo=" crossorigin=anonymous defer></script><script src=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe-ui-default.min.js integrity="sha256-UKkzOn/w1mBxRmLLGrSeyB4e1xbrp4xylgAWb3M42pU=" crossorigin=anonymous defer></script><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/default-skin/default-skin.min.css crossorigin=anonymous><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.css crossorigin=anonymous></main></div><script src=https://cdn.jsdelivr.net/npm/node-vibrant@3.1.6/dist/vibrant.min.js integrity="sha256-awcR2jno4kI5X0zL8ex0vi2z+KMkF24hUW8WePSA9HM=" crossorigin=anonymous></script><script type=text/javascript src=/ts/main.1e9a3bafd846ced4c345d084b355fb8c7bae75701c338f8a1f8a82c780137826.js defer></script><script>(function(){const e=document.createElement("link");e.href="https://fonts.googleapis.com/css2?family=Lato:wght@300;400;700&display=swap",e.type="text/css",e.rel="stylesheet",document.head.appendChild(e)})()</script></body></html>